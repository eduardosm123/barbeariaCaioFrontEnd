<!DOCTYPE html>
<html lang="pt-BR" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Barbearia VIP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { colors: { gold: '#D4AF37', darkgold: '#B8941F' } }
      }
    }
  </script>
</head>

<body class="bg-gray-900 text-white min-h-screen">

  <!-- Login -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gold mb-2">Barbearia VIP</h1>
        <p class="text-gray-400">Administrative Area</p>
      </div>

      <form id="loginForm" class="space-y-4">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-300 mb-2">User</label>
          <input id="username" required
            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
          <div class="relative">
            <input type="password" id="password" required
              class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
              data-target="password" aria-label="Mostrar/ocultar senha">
              <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
        </div>

        <button type="submit" id="loginBtn"
          class="w-full bg-gold hover:bg-darkgold text-black font-semibold py-2 px-4 rounded-lg transition-colors"
          disabled>
          Login
        </button>
      </form>

      <div id="loginError" class="mt-4 p-3 bg-red-900/50 border border-red-500 rounded-lg text-red-200 hidden">
        User or password incorrect!
      </div>
      <div id="apiError" class="mt-4 p-3 bg-red-900/50 border border-red-500 rounded-lg text-red-200 hidden">
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="adminDashboard" class="hidden">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4">
      <div class="container mx-auto flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gold">Admin Dashboard</h1>
        <div class="flex items-center space-x-4">
          <span class="text-gray-300">Welcome, <span id="adminName">Admin</span></span>
          <button id="logoutBtn"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">Logout</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-gray-800 border-b border-gray-700">
      <div class="container mx-auto">
        <div class="flex space-x-8">
          <button class="tab-btn active px-4 py-3 text-white border-b-2 border-gold" data-tab="horarios">Manage
            Hours</button>
          <button
            class="tab-btn px-4 py-3 text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600"
            data-tab="senha">Change Password</button>
        </div>
      </div>
    </nav>

    <!-- Content -->
    <main class="container mx-auto p-6">
      <!-- Horários -->
      <div id="horariosTab" class="tab-content">
        <div class="bg-gray-800 rounded-lg p-6">
          <h2 class="text-xl font-bold mb-6">Manage Available Hours</h2>

          <div id="diasGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- cartões de dias gerados via JS -->
          </div>

          <div class="flex flex-col sm:flex-row sm:justify-between mt-8 gap-4">
            <div class="flex flex-col sm:flex-row gap-2 sm:space-x-4 sm:gap-0">
              <button id="selectAllBtn"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">Select
                All</button>
              <button id="deselectAllBtn"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">Deselect
                All</button>
            </div>
            <button id="saveHorariosBtn"
              class="bg-gold hover:bg-darkgold text-black font-semibold px-6 py-2 rounded-lg transition-colors text-sm">
              Save Changes
            </button>
          </div>

          <div id="saveMsg" class="mt-4 hidden"></div>
        </div>
      </div>

      <!-- Alterar Senha -->
      <div id="senhaTab" class="tab-content hidden">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md">
          <h2 class="text-xl font-bold mb-6">Change Password</h2>

          <form id="senhaForm" class="space-y-4">
            <div>
              <label for="senhaAtual" class="block text-sm font-medium text-gray-300 mb-2">Current
                Password</label>
              <div class="relative">
                <input type="password" id="senhaAtual" required
                  class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                  data-target="senhaAtual" aria-label="Mostrar/ocultar senha">
                  <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
              </div>
            </div>

            <div>
              <label for="novaSenha" class="block text-sm font-medium text-gray-300 mb-2">New
                Password</label>
              <div class="relative">
                <input type="password" id="novaSenha" required
                  class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                  data-target="novaSenha" aria-label="Mostrar/ocultar senha">
                  <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
              </div>
            </div>

            <div>
              <label for="confirmarSenha" class="block text-sm font-medium text-gray-300 mb-2">Confirm New
                Password</label>
              <div class="relative">
                <input type="password" id="confirmarSenha" required
                  class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                  data-target="confirmarSenha" aria-label="Mostrar/ocultar senha">
                  <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
              </div>
            </div>

            <button type="submit"
              class="bg-gold hover:bg-darkgold text-black font-semibold py-2 px-4 rounded-lg transition-colors">
              Change Password
            </button>
          </form>

          <div id="senhaMessage" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API = 'https://barbeariacaio.onrender.com';

    // Estado
    let database = {
      admin: { id: 1, username: '', password: '', email: '' },
      horarios: { segunda: [], terca: [], quarta: [], quinta: [], sexta: [], sabado: [], domingo: [] }
    };
    let bootDone = false;
    let authToken = null; // Para gerenciar o token de autenticação

    // Helpers de fetch com Bearer token
    async function apiGet(path) {
      const headers = {};
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const r = await fetch(`${API}${path}`, { headers });
      if (!r.ok) {
        if (r.status === 401) {
          // Token expirado ou inválido, fazer logout
          handleUnauthorized();
        }
        throw new Error(`GET ${path} -> ${r.status}`);
      }
      return r.json();
    }

    async function apiPut(path, data) {
      const headers = { 'Content-Type': 'application/json' };
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const r = await fetch(`${API}${path}`, {
        method: 'PUT',
        headers,
        body: JSON.stringify(data)
      });
      if (!r.ok) {
        if (r.status === 401) {
          handleUnauthorized();
        }
        throw new Error(`PUT ${path} -> ${r.status}`);
      }
      return r.json();
    }

    async function apiPatch(path, data) {
      const headers = { 'Content-Type': 'application/json' };
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const r = await fetch(`${API}${path}`, {
        method: 'PATCH',
        headers,
        body: JSON.stringify(data)
      });
      if (!r.ok) {
        if (r.status === 401) {
          handleUnauthorized();
        }
        throw new Error(`PATCH ${path} -> ${r.status}`);
      }
      return r.json();
    }

    async function apiPost(path, data) {
      const headers = { 'Content-Type': 'application/json' };
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const r = await fetch(`${API}${path}`, {
        method: 'POST',
        headers,
        body: JSON.stringify(data)
      });
      if (!r.ok) {
        if (r.status === 401) {
          handleUnauthorized();
        }
        throw new Error(`POST ${path} -> ${r.status}`);
      }
      return r.json();
    }

    // Função para lidar com token expirado/inválido
    function handleUnauthorized() {
      authToken = null;
      localStorage.removeItem('adminToken');
      sessionStorage.removeItem('adminLoggedIn');
      
      // Redireciona para tela de login
      loginScreen.classList.remove('hidden');
      adminDashboard.classList.add('hidden');
      
      // Mostra mensagem de erro
      const loginError = document.getElementById('loginError');
      loginError.textContent = 'Sessão expirada. Faça login novamente.';
      loginError.classList.remove('hidden');
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Verifica se há token salvo
        const savedToken = localStorage.getItem('adminToken');
        if (savedToken) {
          authToken = savedToken;

          // Verifica se o token ainda é válido usando a rota de verificação
          try {
            const verifyResponse = await fetch(`${API}/auth/verify`, {
              headers: { 'Authorization': `Bearer ${authToken}` }
            });
            
            if (verifyResponse.ok) {
              // Token válido, busca dados do admin
              try {
                const admins = await apiGet('/admin');
                if (admins && admins.length > 0) {
                  database.admin = admins[0];
                } else {
                  database.admin = { id: 1, username: 'admin', nome: 'Admin' };
                }
                sessionStorage.setItem('adminLoggedIn', 'true');
              } catch (err) {
                console.warn('Erro ao buscar dados do admin:', err);
                database.admin = { id: 1, username: 'admin', nome: 'Admin' };
                sessionStorage.setItem('adminLoggedIn', 'true');
              }
            } else {
              throw new Error('Token inválido');
            }
          } catch (err) {
            console.warn('Token inválido:', err);
            // Token inválido, limpa
            authToken = null;
            localStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminLoggedIn');
          }
        }

        // Carrega horários (rota pública)
        try {
          const horarios = await apiGet('/horarios');
          database.horarios = horarios;
        } catch (err) {
          console.warn('Error loading schedules:', err);
        }

        renderGrid();
        marcarCheckboxes();

        // Se já estava logado e token é válido, vai para o dashboard
        if (sessionStorage.getItem('adminLoggedIn') && authToken && database.admin) {
          document.getElementById('adminName').textContent = database.admin.username || 'Admin';
          showDashboard();
        }

        document.getElementById('loginBtn').disabled = false;
        bootDone = true;
      } catch (err) {
        console.error(err);
        const el = document.getElementById('apiError');
        el.textContent = 'Could not connect to the API (https://barbeariacaio.onrender.com). Check your connection and try again.';
        el.classList.remove('hidden');
      }
    });

    // DOM
    const loginScreen = document.getElementById('loginScreen');
    const adminDashboard = document.getElementById('adminDashboard');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!bootDone) return;

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';

      try {
        // Faz login via API real
        const loginData = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!loginData.ok) {
          const errorData = await loginData.json().catch(() => ({}));
          throw new Error(errorData.message || 'Credenciais inválidas');
        }

        const response = await loginData.json();
        
        // Salva o token retornado pelo backend
        authToken = response.token;
        localStorage.setItem('adminToken', authToken);

        // Usa os dados do admin retornados pelo login
        database.admin = response.admin;

        // Carrega os horários mais recentes
        try {
          const horarios = await apiGet('/horarios');
          database.horarios = horarios;
          marcarCheckboxes(); // atualiza os checkboxes com os dados mais recentes
        } catch (err) {
          console.warn('Error reloading schedules:', err);
        }

        sessionStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('adminName').textContent = database.admin.username || 'Admin';
        loginError.classList.add('hidden');
        showDashboard();
      } catch (err) {
        console.error('Erro no login:', err);
        loginError.textContent = 'Usuário ou senha incorretos!';
        loginError.classList.remove('hidden');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        // Chama a rota de logout no backend
        if (authToken) {
          await fetch(`${API}/auth/logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }).catch(() => {}); // Ignora erros de logout no servidor
        }
      } catch (err) {
        console.warn('Erro no logout do servidor:', err);
      } finally {
        // Sempre limpa o estado local
        authToken = null;
        localStorage.removeItem('adminToken');
        sessionStorage.removeItem('adminLoggedIn');
        window.location.href = 'index.html';
      }
    });

    function showDashboard() {
      loginScreen.classList.add('hidden');
      adminDashboard.classList.remove('hidden');
    }

    // Abas
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        tabBtns.forEach(b => { b.classList.remove('active', 'border-gold', 'text-white'); b.classList.add('text-gray-400', 'border-transparent'); });
        btn.classList.add('active', 'border-gold', 'text-white'); btn.classList.remove('text-gray-400', 'border-transparent');
        tabContents.forEach(c => c.classList.add('hidden'));
        document.getElementById(`${tab}Tab`).classList.remove('hidden');
      });
    });

    // ---- Horários (UI dinâmica)
    const dias = [
      { key: 'segunda', label: 'Monday', abbr: 'seg' },
      { key: 'terca', label: 'Tuesday', abbr: 'ter' },
      { key: 'quarta', label: 'Wednesday', abbr: 'qua' },
      { key: 'quinta', label: 'Thursday', abbr: 'qui' },
      { key: 'sexta', label: 'Friday', abbr: 'sex' },
      { key: 'sabado', label: 'Saturday', abbr: 'sab' },
      { key: 'domingo', label: 'Sunday', abbr: 'dom' }
    ];

    function gerarHalfHours(inicio = '08:00', fim = '22:00') {
      const [hIni, mIni] = inicio.split(':').map(Number);
      const [hFim, mFim] = fim.split(':').map(Number);
      const start = hIni * 60 + mIni;
      const end = hFim * 60 + mFim;
      const out = [];
      for (let t = start; t <= end; t += 30) {
        const h = Math.floor(t / 60).toString().padStart(2, '0');
        const m = (t % 60).toString().padStart(2, '0');
        out.push(`${h}:${m}`);
      }
      return out;
    }
    const slots = gerarHalfHours('08:00', '22:00'); // grade completa; o que ficar marcado vem do backend

    let gridRendered = false;
    function renderGrid() {
      if (gridRendered) return;
      const grid = document.getElementById('diasGrid');
      grid.innerHTML = dias.map(d => {
        const checks = slots.map(s => `
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="${d.abbr}-${s}" class="horario-checkbox" data-dia="${d.key}" data-horario="${s}">
          <label for="${d.abbr}-${s}" class="text-sm">${s}</label>
        </div>
      `).join('');
        return `
        <div class="bg-gray-700 rounded-lg p-4">
          <h3 class="font-semibold text-lg mb-4 text-gold">${d.label}</h3>
          <!-- uma coluna para não parecer duplicado -->
          <div class="space-y-2">${checks}</div>
        </div>
      `;
      }).join('');
      gridRendered = true;
    }

    function marcarCheckboxes() {
      if (!database.horarios) return;

      Object.keys(database.horarios).forEach(dia => {
        const marcados = new Set(database.horarios[dia] || []);
        document.querySelectorAll(`[data-dia="${dia}"]`).forEach(cb => {
          cb.checked = marcados.has(cb.dataset.horario);
        });
      });
    }

    // Selecionar/Desmarcar todos
    document.getElementById('selectAllBtn').addEventListener('click', () => {
      document.querySelectorAll('.horario-checkbox').forEach(cb => cb.checked = true);
    });
    document.getElementById('deselectAllBtn').addEventListener('click', () => {
      document.querySelectorAll('.horario-checkbox').forEach(cb => cb.checked = false);
    });

    // Salvar horários -> PATCH /horarios
    document.getElementById('saveHorariosBtn').addEventListener('click', async () => {
      const novo = { segunda: [], terca: [], quarta: [], quinta: [], sexta: [], sabado: [], domingo: [] };
      Object.keys(novo).forEach(dia => {
        document.querySelectorAll(`[data-dia="${dia}"]:checked`).forEach(cb => {
          novo[dia].push(cb.dataset.horario);
        });
      });

      const btn = document.getElementById('saveHorariosBtn');
      const saveMsg = document.getElementById('saveMsg');
      btn.disabled = true;

      try {
        const atualizado = await apiPatch('/horarios', novo);
        database.horarios = atualizado; // mantém em memória
        saveMsg.textContent = 'Schedules saved successfully!';
        saveMsg.className = 'mt-4 p-3 rounded-lg bg-green-900/50 border border-green-500 text-green-200';
      } catch (err) {
        console.error(err);
        saveMsg.textContent = 'Failed to save schedules. Please check the server.';
        saveMsg.className = 'mt-4 p-3 rounded-lg bg-red-900/50 border border-red-500 text-red-200';
      } finally {
        saveMsg.classList.remove('hidden');
        btn.disabled = false;
        setTimeout(() => saveMsg.classList.add('hidden'), 4000);
      }
    });

    // Alterar senha -> PATCH /admin/1
    document.getElementById('senhaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const senhaAtual = document.getElementById('senhaAtual').value;
      const novaSenha = document.getElementById('novaSenha').value;
      const confirmar = document.getElementById('confirmarSenha').value;
      const msg = document.getElementById('senhaMessage');

      function show(type, text) {
        msg.textContent = text;
        msg.className = 'mt-4 p-3 rounded-lg ' + (type === 'error'
          ? 'bg-red-900/50 border border-red-500 text-red-200'
          : 'bg-green-900/50 border border-green-500 text-green-200');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 5000);
      }

      if (!authToken) {
        return show('error', 'Session expired. Please log in again.');
      }

      if (novaSenha !== confirmar) return show('error', 'Passwords do not match!');
      if (novaSenha.length < 6) return show('error', 'New password must be at least 6 characters long!');

      try {
        // Primeiro verifica se a senha atual está correta tentando login
        const testLogin = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: database.admin.username, password: senhaAtual })
        });

        if (!testLogin.ok) {
          return show('error', 'Current password is incorrect!');
        }

        // Atualiza a senha usando a rota PATCH /admin/:id
        const updated = await apiPatch(`/admin/${database.admin.id}`, { password: novaSenha });
        database.admin = { ...database.admin, ...updated };
        (document.getElementById('senhaForm')).reset();
        show('success', 'Password changed successfully!');
      } catch (err) {
        console.error(err);
        show('error', 'Failed to update password. Please check the server.');
      }
    });

    // Mostrar/ocultar senha (3 campos + login)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.toggle-password');
      if (!btn) return;
      const id = btn.dataset.target;
      const input = document.getElementById(id);
      const tipo = input.getAttribute('type') === 'password' ? 'text' : 'password';
      input.setAttribute('type', tipo);
    });
  </script>

</body>

</html>