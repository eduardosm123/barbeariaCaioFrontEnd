<!DOCTYPE html>
<html lang="pt-BR" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Barbearia VIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { gold: '#D4AF37', darkgold: '#B8941F' } }
            }
        }
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen">

    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gold mb-2">Barbearia VIP</h1>
                <p class="text-gray-400">Administrative Area</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">User</label>
                    <input id="username" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" required
                            class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                            data-target="password" aria-label="Mostrar/ocultar senha">
                            <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" id="loginBtn"
                    class="w-full bg-gold hover:bg-darkgold text-black font-semibold py-2 px-4 rounded-lg transition-colors"
                    disabled>
                    Login
                </button>
            </form>

            <div id="loginError" class="mt-4 p-3 bg-red-900/50 border border-red-500 rounded-lg text-red-200 hidden">
                User or password incorrect!
            </div>
            <div id="apiError" class="mt-4 p-3 bg-red-900/50 border border-red-500 rounded-lg text-red-200 hidden">
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="hidden">
        <header class="bg-gray-800 border-b border-gray-700 p-4">
            <div class="container mx-auto flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gold">Admin Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-300">Welcome, <span id="adminName">Admin</span></span>
                    <button id="logoutBtn"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">Logout</button>
                </div>
            </div>
        </header>

        <nav class="bg-gray-800 border-b border-gray-700">
            <div class="container mx-auto">
                <div class="flex space-x-8">
                    <button class="tab-btn active px-4 py-3 text-white border-b-2 border-gold"
                        data-tab="agendamentos">Appointments</button>
                    <button class="tab-btn px-4 py-3 text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600"
                        data-tab="horarios">Manage Hours</button>
                    <button
                        class="tab-btn px-4 py-3 text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600"
                        data-tab="senha">Change Password</button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-6">
            <div id="agendamentosTab" class="tab-content">
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Manage Appointments</h2>
                        <div class="flex gap-2">
                            <button id="novoAgendamentoBtn"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                ‚ûï New Appointment
                            </button>
                            <button id="limparAgendamentosPassados"
                                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üóëÔ∏è Clean Past
                            </button>
                            <button id="recarregarAgendamentos"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üîÑ Reload
                            </button>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-700 rounded-lg">
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Date</label>
                        <input type="date" id="filtroData" 
                          class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white h-[40px]">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Status</label>
                        <select id="filtroStatus" 
                          class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white h-[40px]">
                          <option value="">All statuses</option>
                          <option value="pendente">Pending</option>
                          <option value="confirmado">Confirmed</option>
                          <option value="cancelado">Canceled</option>
                          <option value="finalizado">Finished</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Actions</label>
                        <button id="limparFiltros"
                          class="w-full bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-colors text-sm h-[40px]">
                          Clear Filters
                        </button>
                      </div>
                    </div>

                    <div id="agendamentosLista" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            Loading appointments...
                        </div>
                    </div>

                    <div id="paginationContainer" class="mt-6 hidden">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="text-sm text-gray-400">
                                Showing <span id="paginationInfo">0-0 of 0</span> appointments
                                <span id="pageInfo" class="ml-2 text-gold font-medium"></span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button id="firstPageBtn" 
                                    class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                    ‚á§ First
                                </button>
                                <button id="prevPageBtn" 
                                    class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                    ‚Üê Previous
                                </button>
                                <span id="pageNumbers" class="flex items-center space-x-1"></span>
                                <button id="nextPageBtn" 
                                    class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                    Next ‚Üí
                                </button>
                                <button id="lastPageBtn" 
                                    class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                    Last ‚á•
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="agendamentosMsg" class="mt-4 hidden"></div>
                </div>
            </div>

            <div id="horariosTab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-6">Manage Available Hours</h2>

                    <div id="diasGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>

                    <div class="flex flex-col sm:flex-row sm:justify-between mt-8 gap-4">
                      <div class="flex flex-col sm:flex-row gap-2 sm:space-x-4 sm:gap-0">
                        <button id="selectAllBtn"
                          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">Select
                          All</button>
                        <button id="deselectAllBtn"
                          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">Deselect
                          All</button>
                      </div>
                      <button id="saveHorariosBtn"
                        class="bg-gold hover:bg-darkgold text-black font-semibold px-6 py-2 rounded-lg transition-colors text-sm">
                        Save Changes
                      </button>
                    </div>

                    <div id="saveMsg" class="mt-4 hidden"></div>
                </div>
                
                <button id="backToTopBtn" 
                    class="fixed bottom-6 right-6 bg-gold hover:bg-darkgold text-black p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 invisible z-40">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                    </svg>
                </button>
            </div>

            <div id="senhaTab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg p-6 max-w-md">
                    <h2 class="text-xl font-bold mb-6">Change Password</h2>

                    <form id="senhaForm" class="space-y-4">
                        <div>
                            <label for="senhaAtual" class="block text-sm font-medium text-gray-300 mb-2">Current
                                Password</label>
                            <div class="relative">
                                <input type="password" id="senhaAtual" required
                                    class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                                <button type="button"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                                    data-target="senhaAtual" aria-label="Mostrar/ocultar senha">
                                    <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label for="novaSenha" class="block text-sm font-medium text-gray-300 mb-2">New
                                Password</label>
                            <div class="relative">
                                <input type="password" id="novaSenha" required
                                    class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                                <button type="button"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                                    data-target="novaSenha" aria-label="Mostrar/ocultar senha">
                                    <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label for="confirmarSenha" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                            <div class="relative">
                                <input type="password" id="confirmarSenha" required
                                    class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                                <button type="button"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password"
                                    data-target="confirmarSenha" aria-label="Mostrar/ocultar senha">
                                    <svg class="h-5 w-5 text-gray-400 hover:text-gray-300" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <button type="submit"
                            class="bg-gold hover:bg-darkgold text-black font-semibold py-2 px-4 rounded-lg transition-colors">
                            Change Password
                        </button>
                    </form>

                    <div id="senhaMessage" class="mt-4 p-3 rounded-lg hidden"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gold">Edit Appointment</h2>
                    <button id="closeEditModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <form id="editForm" class="p-6 space-y-4">
                <input type="hidden" id="editAgendamentoId">
                
                <div>
                    <label for="editNome" class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                    <input type="text" id="editNome" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label for="editTelefone" class="block text-sm font-medium text-gray-300 mb-2">Phone</label>
                    <input type="tel" id="editTelefone" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Service</label>
                    <div id="editServicosGroup" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="checkbox" name="editServicos" value="Corte Masculino" data-minutos="20" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between
                                hover:border-gold transition-colors
                                peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Corte Masculino</span>
                                <span class="text-gold font-semibold">20 min</span>
                            </div>
                        </label>

                        <label class="cursor-pointer">
                            <input type="checkbox" name="editServicos" value="Barba & Bigode" data-minutos="10" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between
                                hover:border-gold transition-colors
                                peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Barba & Bigode</span>
                                <span class="text-gold font-semibold">10 min</span>
                            </div>
                        </label>

                        <label class="cursor-pointer">
                            <input type="checkbox" name="editServicos" value="Skincare" data-minutos="15" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between
                                hover:border-gold transition-colors
                                peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Skincare</span>
                                <span class="text-gold font-semibold">15 min</span>
                            </div>
                        </label>

                        <label class="cursor-pointer">
                            <input type="checkbox" name="editServicos" value="Queratina" data-minutos="60" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between
                                hover:border-gold transition-colors
                                peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Queratina</span>
                                <span class="text-gold font-semibold">1h</span>
                            </div>
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Select one or more services</p>
                </div>

                <div>
                    <label for="editData" class="block text-sm font-medium text-gray-300 mb-2">Date</label>
                    <input type="date" id="editData" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label for="editHorario" class="block text-sm font-medium text-gray-300 mb-2">Time</label>
                    <input type="time" id="editHorario" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label for="editStatus" class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                    <select id="editStatus" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                        <option value="pendente">Pending</option>
                        <option value="confirmado">Confirmed</option>
                        <option value="cancelado">Canceled</option>
                        <option value="finalizado">Finished</option>
                    </select>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelEditBtn"
                        class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-gold hover:bg-darkgold text-black font-semibold rounded-lg transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="novoAgendamentoModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gold">New Appointment</h2>
                    <button id="closeNovoAgendamentoModal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <form id="novoAgendamentoForm" class="p-6 space-y-4">
                <div>
                    <label for="novoNome" class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                    <input type="text" id="novoNome" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label for="novoTelefone" class="block text-sm font-medium text-gray-300 mb-2">Phone</label>
                    <input type="tel" id="novoTelefone" required inputmode="tel"
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white"
                        placeholder="(00) 00000-0000" pattern="^\(\d{2}\) \d{4,5}-\d{4}$" maxlength="15">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Services</label>
                    <div id="novoServicosGroup" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="checkbox" name="novoServicos" value="Corte Masculino" data-minutos="20" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between hover:border-gold transition-colors peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Corte Masculino</span>
                                <span class="text-gold font-semibold">20 min</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="novoServicos" value="Barba & Bigode" data-minutos="10" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between hover:border-gold transition-colors peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Barba & Bigode</span>
                                <span class="text-gold font-semibold">10 min</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="novoServicos" value="Skincare" data-minutos="15" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between hover:border-gold transition-colors peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Skincare</span>
                                <span class="text-gold font-semibold">15 min</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="novoServicos" value="Queratina" data-minutos="60" class="peer sr-only">
                            <div class="w-full rounded-lg border border-gray-600 px-3 py-2 text-sm flex items-center justify-between hover:border-gold transition-colors peer-checked:border-gold peer-checked:bg-gold/10">
                                <span class="font-medium">Queratina</span>
                                <span class="text-gold font-semibold">1h</span>
                            </div>
                        </label>
                    </div>
                    <p id="novoServicosErro" class="text-sm text-red-400 mt-1 hidden">Select at least one service.</p>
                </div>

                <div>
                    <label for="novoData" class="block text-sm font-medium text-gray-300 mb-2">Date</label>
                    <input type="date" id="novoData" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                </div>

                <div>
                    <label for="novoHorario" class="block text-sm font-medium text-gray-300 mb-2">Time</label>
                    <select id="novoHorario" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                        <option value="">Select a date first</option>
                    </select>
                </div>

                <div>
                    <label for="novoStatus" class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                    <select id="novoStatus" required
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent text-white">
                        <option value="pendente">Pending</option>
                        <option value="confirmado" selected>Confirmed</option>
                        <option value="cancelado">Canceled</option>
                        <option value="finalizado">Finished</option>
                    </select>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelNovoAgendamentoBtn"
                        class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-gold hover:bg-darkgold text-black font-semibold rounded-lg transition-colors">
                        Create Appointment
                    </button>
                </div>
            </form>
        </div>
    </div>


 <script>
  const API = 'https://barbeariacaio.onrender.com';

  // Estado
  let database = {
    admin: { id: 1, username: '', password: '', email: '' },
    horarios: { segunda: [], terca: [], quarta: [], quinta: [], sexta: [], sabado: [], domingo: [] },
    agendamentos: []
  };
  let bootDone = false;
  let sessionId = null; // Para gerenciar a sess√£o
  
  // Estado de pagina√ß√£o
  let currentPage = 1;
  let totalPages = 1;
  let totalItems = 0;
  let itemsPerPage = 5;
  let currentFilters = {
    data: null,
    status: null,
    sortBy: 'created_at',
    sortOrder: 'desc'
  };
  
  // Fun√ß√µes para gerenciar cookies
  function setCookie(name, value, days = 7) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
  }

  function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
    }
    return null;
  }

  function deleteCookie(name) {
    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
  }

  // Credenciais armazenadas para uso nas opera√ß√µes
  let storedCredentials = {
    username: '',
    password: ''
  };

  // Helpers de fetch com session ID
  async function apiGet(path) {
    const headers = {};
    if (sessionId) {
      headers['X-Session-Id'] = sessionId;
    }
    
    const r = await fetch(`${API}${path}`, { headers });
    if (!r.ok) throw new Error(`GET ${path} -> ${r.status}`);
    return r.json();
  }
  
  async function apiPut(path, data) {
    const headers = { 'Content-Type': 'application/json' };
    if (sessionId) {
      headers['X-Session-Id'] = sessionId;
    }
    
    const r = await fetch(`${API}${path}`, {
      method: 'PUT',
      headers,
      body: JSON.stringify(data)
    });
    if (!r.ok) throw new Error(`PUT ${path} -> ${r.status}`);
    return r.json();
  }
  
  async function apiPatch(path, data) {
    const headers = { 'Content-Type': 'application/json' };
    if (sessionId) {
      headers['X-Session-Id'] = sessionId;
    }
    
    const r = await fetch(`${API}${path}`, {
      method: 'PATCH',
      headers,
      body: JSON.stringify(data)
    });
    if (!r.ok) throw new Error(`PATCH ${path} -> ${r.status}`);
    return r.json();
  }
  
  async function apiPost(path, data) {
    const headers = { 'Content-Type': 'application/json' };
    if (sessionId) {
      headers['X-Session-Id'] = sessionId;
    }
    
    const r = await fetch(`${API}${path}`, {
      method: 'POST',
      headers,
      body: JSON.stringify(data)
    });
    if (!r.ok) {
        const errorBody = await r.json().catch(() => ({ message: 'Unknown error' }));
        throw new Error(errorBody.message || `POST ${path} -> ${r.status}`);
    }
    return r.json();
  }
  
  async function apiDelete(path) {
    const headers = { 'Content-Type': 'application/json' };
    if (sessionId) {
      headers['X-Session-Id'] = sessionId;
    }
    
    const r = await fetch(`${API}${path}`, {
      method: 'DELETE',
      headers
    });
    if (!r.ok) throw new Error(`DELETE ${path} -> ${r.status}`);
    return r.json();
  }

  // Fun√ß√µes espec√≠ficas para agendamentos
  async function carregarAgendamentosPaginados(page = 1, filters = {}) {
    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: itemsPerPage.toString(),
        sortBy: currentFilters.sortBy,
        sortOrder: currentFilters.sortOrder
      });

      // Adicionar filtros se existirem
      if (filters.data) {
        params.append('data', filters.data);
      }
      if (filters.status) {
        params.append('status', filters.status);
      }

      const url = `/agendamentos/paginated?${params.toString()}`;
      console.log('üìã Carregando agendamentos paginados:', url);
      
      const response = await apiGet(url);
      console.log('üìã Resposta da API paginada:', response);
      
      // Atualizar estado de pagina√ß√£o
      currentPage = response.pagination.currentPage;
      totalPages = response.pagination.totalPages;
      totalItems = response.pagination.totalItems;
      
      // Atualizar filtros atuais
      currentFilters.data = response.filters.data;
      currentFilters.status = response.filters.status;
      
      // Armazenar agendamentos no database para manter compatibilidade
      database.agendamentos = response.data;
      
      return response;
    } catch (err) {
      console.error('Erro ao carregar agendamentos paginados:', err);
      throw err;
    }
  }

  async function carregarAgendamentos() {
    try {
      const agendamentos = await apiGet('/agendamentos');
      console.log('üìã Agendamentos carregados da API:', agendamentos);
      console.log('üìã Primeiro agendamento (estrutura):', agendamentos[0]);
      console.log('üìã Tipos de ID dos agendamentos:', agendamentos.map(ag => ({ id: ag.id, tipo: typeof ag.id })));
      
      database.agendamentos = agendamentos;
      return agendamentos;
    } catch (err) {
      console.error('Erro ao carregar agendamentos:', err);
      return [];
    }
  }

  async function atualizarAgendamento(id, dadosAtualizados) {
    try {
      console.log('üîÑ Atualizando agendamento:', { id, dadosAtualizados });
      console.log('üîÑ URL da requisi√ß√£o:', `${API}/agendamentos/${id}`);
      
      const agendamentoAtualizado = await apiPatch(`/agendamentos/${id}`, dadosAtualizados);
      console.log('‚úÖ Agendamento atualizado com sucesso:', agendamentoAtualizado);
      
      return agendamentoAtualizado;
    } catch (err) {
      console.error('‚ùå Erro ao atualizar agendamento:', err);
      throw err;
    }
  }

  async function excluirAgendamento(id) {
    try {
      await apiDelete(`/agendamentos/${id}`);
      return true;
    } catch (err) {
      console.error('Erro ao excluir agendamento:', err);
      throw err;
    }
  }

  async function limparAgendamentosPassados() {
    try {
      const response = await apiDelete('/agendamentos/cleanup/past');
      console.log('‚úÖ Limpeza de agendamentos passados:', response);
      return response;
    } catch (err) {
      console.error('Erro ao limpar agendamentos passados:', err);
      throw err;
    }
  }

  // Inicializa√ß√£o
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Carrega credenciais dos cookies se existirem
      const savedUsername = getCookie('adminUsername');
      const savedPassword = getCookie('adminPassword');
      if (savedUsername && savedPassword) {
        storedCredentials.username = savedUsername;
        storedCredentials.password = savedPassword;
      }

      // Verifica se h√° sess√£o salva
      const savedSessionId = sessionStorage.getItem('adminSessionId');
      if (savedSessionId) {
        sessionId = savedSessionId;
        
        // Verifica se a sess√£o ainda √© v√°lida
        try {
          const verify = await apiGet('/auth/verify');
          if (verify.valid) {
            database.admin = verify.admin;
            sessionStorage.setItem('adminLoggedIn', 'true');
          } else {
            // Sess√£o inv√°lida, limpa
            sessionId = null;
            sessionStorage.removeItem('adminSessionId');
            sessionStorage.removeItem('adminLoggedIn');
          }
        } catch (err) {
          // Erro na verifica√ß√£o, limpa a sess√£o
          sessionId = null;
          sessionStorage.removeItem('adminSessionId');
          sessionStorage.removeItem('adminLoggedIn');
        }
      }

      // Carrega hor√°rios (n√£o precisa de autentica√ß√£o)
      try {
        const horarios = await apiGet('/horarios');
        database.horarios = horarios;
      } catch (err) {
        console.warn('Erro ao carregar hor√°rios:', err);
      }

      renderGrid();
      marcarCheckboxes();
      
      // Se j√° estava logado e sess√£o √© v√°lida, vai para o dashboard
      if (sessionStorage.getItem('adminLoggedIn') && sessionId) {
        showDashboard();
        // Carrega agendamentos se j√° est√° logado
        carregarEMostrarAgendamentos();
      }

      document.getElementById('loginBtn').disabled = false;
      bootDone = true;
    } catch (err) {
      console.error(err);
      const el = document.getElementById('apiError');
      el.textContent = 'Could not connect to the API (https://barbeariacaio.onrender.com). Check your connection and try again.';
      el.classList.remove('hidden');
    }
  });

  // DOM
  const loginScreen = document.getElementById('loginScreen');
  const adminDashboard = document.getElementById('adminDashboard');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const logoutBtn = document.getElementById('logoutBtn');

  // Login
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!bootDone) return;

    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.textContent = 'Entrando...';

    try {
      // Tenta fazer login via API
      const loginData = await apiPost('/auth/login', { username, password });
      
      // Salva o sessionId
      sessionId = loginData.sessionId;
      sessionStorage.setItem('adminSessionId', sessionId);
      
      // Salva as credenciais em cookies para uso posterior
      setCookie('adminUsername', username, 7);
      setCookie('adminPassword', password, 7);
      
      // Atualiza as credenciais armazenadas
      storedCredentials.username = username;
      storedCredentials.password = password;
      
      // Dados do admin v√™m na resposta do login
      database.admin = loginData.admin;
      
      // Carrega os hor√°rios mais recentes
      try {
        const horarios = await apiGet('/horarios');
        database.horarios = horarios;
        marcarCheckboxes(); // atualiza os checkboxes com os dados mais recentes
      } catch (err) {
        console.warn('Erro ao recarregar hor√°rios:', err);
      }

      sessionStorage.setItem('adminLoggedIn', 'true');
      document.getElementById('adminName').textContent = loginData.admin.username || 'Admin';
      loginError.classList.add('hidden');
      showDashboard();
      
      // Carrega agendamentos ap√≥s login bem-sucedido
      carregarEMostrarAgendamentos();
    } catch (err) {
      console.error('Erro no login:', err);
      loginError.classList.remove('hidden');
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = 'Entrar';
    }
  });

  // Logout
  logoutBtn.addEventListener('click', async () => {
    try {
      // Tenta fazer logout via API (limpa a sess√£o no servidor)
      if (sessionId) {
        await apiPost('/auth/logout', {});
      }
    } catch (err) {
      console.warn('Erro ao fazer logout no servidor:', err);
    } finally {
      // Sempre limpa o estado local
      sessionId = null;
      sessionStorage.removeItem('adminLoggedIn');
      sessionStorage.removeItem('adminSessionId');
      
      // Limpa os cookies das credenciais
      deleteCookie('adminUsername');
      deleteCookie('adminPassword');
      
      // Limpa as credenciais armazenadas
      storedCredentials.username = '';
      storedCredentials.password = '';
      
      window.location.href = 'admin.html'; // Recarrega a p√°gina de admin para a tela de login
    }
  });

  function showDashboard() {
    loginScreen.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
  }

  // Abas
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      tabBtns.forEach(b => { b.classList.remove('active', 'border-gold', 'text-white'); b.classList.add('text-gray-400', 'border-transparent'); });
      btn.classList.add('active', 'border-gold', 'text-white'); btn.classList.remove('text-gray-400', 'border-transparent');
      tabContents.forEach(c => c.classList.add('hidden'));
      document.getElementById(`${tab}Tab`).classList.remove('hidden');
    });
  });

  // ---- Hor√°rios (UI din√¢mica)
  const dias = [
    { key: 'segunda', label: 'Monday', abbr: 'seg' },
    { key: 'terca', label: 'Tuesday', abbr: 'ter' },
    { key: 'quarta', label: 'Wednesday', abbr: 'qua' },
    { key: 'quinta', label: 'Thursday', abbr: 'qui' },
    { key: 'sexta', label: 'Friday', abbr: 'sex' },
    { key: 'sabado', label: 'Saturday', abbr: 'sab' },
    { key: 'domingo', label: 'Sunday', abbr: 'dom' }
  ];

  function gerarHalfHours(inicio = '08:00', fim = '22:00') {
    const [hIni, mIni] = inicio.split(':').map(Number);
    const [hFim, mFim] = fim.split(':').map(Number);
    const start = hIni * 60 + mIni;
    const end = hFim * 60 + mFim;
    const out = [];
    for (let t = start; t <= end; t += 30) {
      const h = Math.floor(t / 60).toString().padStart(2, '0');
      const m = (t % 60).toString().padStart(2, '0');
      out.push(`${h}:${m}`);
    }
    return out;
  }
  const slots = gerarHalfHours('08:00', '22:00'); // grade completa; o que ficar marcado vem do backend

  let gridRendered = false;
  function renderGrid() {
    if (gridRendered) return;
    const grid = document.getElementById('diasGrid');
    grid.innerHTML = dias.map(d => {
      const checks = slots.map(s => `
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="${d.abbr}-${s}" class="horario-checkbox" data-dia="${d.key}" data-horario="${s}">
          <label for="${d.abbr}-${s}" class="text-sm">${s}</label>
        </div>
      `).join('');
      return `
        <div class="bg-gray-700 rounded-lg p-4">
          <h3 class="font-semibold text-lg mb-4 text-gold">${d.label}</h3>
          <div class="space-y-2">${checks}</div>
        </div>
      `;
    }).join('');
    gridRendered = true;
  }

  function marcarCheckboxes() {
    if (!database.horarios) return;
    
    Object.keys(database.horarios).forEach(dia => {
      const marcados = new Set(database.horarios[dia] || []);
      document.querySelectorAll(`[data-dia="${dia}"]`).forEach(cb => {
        cb.checked = marcados.has(cb.dataset.horario);
      });
    });
  }

  // Selecionar/Desmarcar todos
  document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.horario-checkbox').forEach(cb => cb.checked = true);
  });
  document.getElementById('deselectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.horario-checkbox').forEach(cb => cb.checked = false);
  });

  // Salvar hor√°rios -> PATCH /horarios
  document.getElementById('saveHorariosBtn').addEventListener('click', async () => {
    const novo = { segunda: [], terca: [], quarta: [], quinta: [], sexta: [], sabado: [], domingo: [] };
    Object.keys(novo).forEach(dia => {
      document.querySelectorAll(`[data-dia="${dia}"]:checked`).forEach(cb => {
        novo[dia].push(cb.dataset.horario);
      });
    });

    const btn = document.getElementById('saveHorariosBtn');
    const saveMsg = document.getElementById('saveMsg');
    btn.disabled = true;

    try {
      const atualizado = await apiPatch('/horarios', novo);
      database.horarios = atualizado; // mant√©m em mem√≥ria
      saveMsg.textContent = 'Hor√°rios salvos com sucesso!';
      saveMsg.className = 'mt-4 p-3 rounded-lg bg-green-900/50 border border-green-500 text-green-200';
    } catch (err) {
      console.error('Erro ao salvar hor√°rios:', err);
      saveMsg.textContent = 'Falha ao salvar hor√°rios. Verifique o servidor ou credenciais.';
      saveMsg.className = 'mt-4 p-3 rounded-lg bg-red-900/50 border border-red-500 text-red-200';
    } finally {
      saveMsg.classList.remove('hidden');
      btn.disabled = false;
      setTimeout(() => saveMsg.classList.add('hidden'), 4000);
    }
  });

  // Alterar senha -> PATCH /admin/1
  document.getElementById('senhaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const senhaAtual = document.getElementById('senhaAtual').value;
    const novaSenha = document.getElementById('novaSenha').value;
    const confirmar = document.getElementById('confirmarSenha').value;
    const msg = document.getElementById('senhaMessage');

    function show(type, text) {
      msg.textContent = text;
      msg.className = 'mt-4 p-3 rounded-lg ' + (type === 'error'
        ? 'bg-red-900/50 border border-red-500 text-red-200'
        : 'bg-green-900/50 border border-green-500 text-green-200');
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 5000);
    }

    if (!sessionId) {
      return show('error', 'Sess√£o expirada. Fa√ßa login novamente.');
    }

    if (novaSenha !== confirmar) return show('error', 'As senhas n√£o coincidem!');
    if (novaSenha.length < 6) return show('error', 'A nova senha deve ter pelo menos 6 caracteres!');

    try {
      // First verify if the current password is correct by attempting login
      const testLogin = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: database.admin.username, password: senhaAtual })
      });
      
      if (!testLogin.ok) {
      return show('error', 'Current password is incorrect!');
      }

      const updated = await apiPatch('/admin/1', { password: novaSenha });
      database.admin = { ...database.admin, ...updated };
      
      // Atualiza as credenciais armazenadas com a nova senha
      storedCredentials.password = novaSenha;
      
      // Atualiza o cookie com a nova senha
      setCookie('adminPassword', novaSenha, 7);
      
      (document.getElementById('senhaForm')).reset();
      show('success', 'Password changed successfully!');
    } catch (err) {
      console.error(err);
      show('error', 'Failed to update password. Please check the server.');
    }
  });

  // Mostrar/ocultar senha (3 campos + login)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.toggle-password');
    if (!btn) return;
    const id = btn.dataset.target;
    const input = document.getElementById(id);
    const tipo = input.getAttribute('type') === 'password' ? 'text' : 'password';
    input.setAttribute('type', tipo);
  });

  // ---- GEST√ÉO DE AGENDAMENTOS ----

  function formatarData(dataStr) {
    if (!dataStr) return 'N/A';
    // Adiciona T00:00:00 para evitar problemas de fuso hor√°rio
    return new Date(`${dataStr}T00:00:00`).toLocaleDateString('pt-BR');
  }

  function formatarStatus(status) {
    const statusMap = {
      'pendente': { text: 'Pending', class: 'bg-yellow-900/50 border-yellow-500 text-yellow-200' },
      'confirmado': { text: 'Confirmed', class: 'bg-green-900/50 border-green-500 text-green-200' },
      'cancelado': { text: 'Canceled', class: 'bg-red-900/50 border-red-500 text-red-200' },
      'finalizado': { text: 'Finished', class: 'bg-blue-900/50 border-blue-500 text-blue-200' }
    };
    return statusMap[status] || { text: status, class: 'bg-gray-900/50 border-gray-500 text-gray-200' };
  }

  function criarCardAgendamento(agendamento) {
    const statusInfo = formatarStatus(agendamento.status);
    const agId = String(agendamento.id); // Converter para string sempre
    
    return `
      <div class="bg-gray-700 rounded-lg p-4 border border-gray-600" data-agendamento-id="${agId}">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="font-semibold text-lg text-white">${agendamento.nome}</h3>
            <p class="text-gray-300 text-sm">${agendamento.telefone}</p>
          </div>
          <span class="px-2 py-1 rounded-full text-xs border ${statusInfo.class}">
            ${statusInfo.text}
          </span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
            <div>
            <span class="text-gray-400">Service:</span>
            <p class="text-white font-medium">${agendamento.servico}</p>
            </div>
            <div>
            <span class="text-gray-400">Date:</span>
            <p class="text-white font-medium">${formatarData(agendamento.data)}</p>
            </div>
            <div>
            <span class="text-gray-400">Time:</span>
            <p class="text-white font-medium">${agendamento.horario}</p>
            </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <button class="editar-agendamento-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                  data-agendamento-id="${agId}">
            ‚úèÔ∏è Edit
          </button>
          
          <select class="status-select px-2 py-1 bg-gray-600 border border-gray-500 rounded text-white text-sm" 
                  data-agendamento-id="${agId}">
            <option value="pendente" ${agendamento.status === 'pendente' ? 'selected' : ''}>Pending</option>
            <option value="confirmado" ${agendamento.status === 'confirmado' ? 'selected' : ''}>Confirmed</option>
            <option value="cancelado" ${agendamento.status === 'cancelado' ? 'selected' : ''}>Canceled</option>
            <option value="finalizado" ${agendamento.status === 'finalizado' ? 'selected' : ''}>Finished</option>
          </select>
          
          <button class="salvar-status-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors"
                  data-agendamento-id="${agId}">
            üíæ Save Status
          </button>
          
          <button class="excluir-agendamento-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors"
                  data-agendamento-id="${agId}">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    `;
  }

  async function carregarEMostrarAgendamentos(page = 1, resetFilters = false) {
    const lista = document.getElementById('agendamentosLista');
    const paginationContainer = document.getElementById('paginationContainer');
    
    lista.innerHTML = '<div class="text-center py-8 text-gray-400">Loading appointments...</div>';
    paginationContainer.classList.add('hidden');

    try {
      // Se resetFilters for true, limpa os filtros
      if (resetFilters) {
        currentFilters.data = null;
        currentFilters.status = null;
        document.getElementById('filtroData').value = '';
        document.getElementById('filtroStatus').value = '';
      }

      // Obter filtros atuais dos campos de input
      const filtros = {
        data: document.getElementById('filtroData').value || null,
        status: document.getElementById('filtroStatus').value || null
      };

      const response = await carregarAgendamentosPaginados(page, filtros);
      
      mostrarAgendamentos(response.data);
      atualizarPaginacao(response.pagination);
      
    } catch (err) {
      console.error('Erro ao carregar agendamentos:', err);
      lista.innerHTML = '<div class="text-center py-8 text-red-400">Error loading appointments</div>';
    }
  }

  function mostrarAgendamentos(agendamentos) {
    const lista = document.getElementById('agendamentosLista');
    
    if (!agendamentos || agendamentos.length === 0) {
      lista.innerHTML = '<div class="text-center py-8 text-gray-400">No appointments found</div>';
      return;
    }

    lista.innerHTML = agendamentos.map(agendamento => criarCardAgendamento(agendamento)).join('');
  }

  function atualizarPaginacao(pagination) {
    const container = document.getElementById('paginationContainer');
    const info = document.getElementById('paginationInfo');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const firstBtn = document.getElementById('firstPageBtn');
    const lastBtn = document.getElementById('lastPageBtn');
    const pageNumbers = document.getElementById('pageNumbers');

    if (pagination.totalItems === 0) {
      container.classList.add('hidden');
      return;
    }

    container.classList.remove('hidden');

    // Atualizar informa√ß√µes
    const start = ((pagination.currentPage - 1) * pagination.itemsPerPage) + 1;
    const end = Math.min(start + pagination.itemsPerPage - 1, pagination.totalItems);
    info.textContent = `${start}-${end} of ${pagination.totalItems}`;
    
    // Mostrar informa√ß√£o da p√°gina atual
    pageInfo.textContent = `(Page ${pagination.currentPage} of ${pagination.totalPages})`;

    // Atualizar bot√µes de navega√ß√£o
    const isFirstPage = pagination.currentPage === 1;
    const isLastPage = pagination.currentPage === pagination.totalPages;
    
    prevBtn.disabled = !pagination.hasPrevPage;
    nextBtn.disabled = !pagination.hasNextPage;
    firstBtn.disabled = isFirstPage;
    lastBtn.disabled = isLastPage;

    // Gerar n√∫meros das p√°ginas com l√≥gica melhorada
    pageNumbers.innerHTML = '';
    const maxVisiblePages = 5;
    
    if (pagination.totalPages <= maxVisiblePages) {
      // Se tem 5 p√°ginas ou menos, mostra todas
      for (let i = 1; i <= pagination.totalPages; i++) {
        criarBotaoPagina(i, pagination.currentPage === i);
      }
    } else {
      // L√≥gica para mais de 5 p√°ginas
      let startPage, endPage;
      
      if (pagination.currentPage <= 3) {
        // In√≠cio: mostra [1] [2] [3] [4] [5] ... [last]
        startPage = 1;
        endPage = 5;
      } else if (pagination.currentPage >= pagination.totalPages - 2) {
        // Final: mostra [1] ... [n-4] [n-3] [n-2] [n-1] [n]
        startPage = pagination.totalPages - 4;
        endPage = pagination.totalPages;
      } else {
        // Meio: mostra [1] ... [current-1] [current] [current+1] ... [last]
        startPage = pagination.currentPage - 1;
        endPage = pagination.currentPage + 1;
      }
      
      // Primeira p√°gina (se n√£o estiver no in√≠cio)
      if (startPage > 1) {
        criarBotaoPagina(1, false);
        if (startPage > 2) {
          criarReticencias();
        }
      }
      
      // P√°ginas do meio
      for (let i = startPage; i <= endPage; i++) {
        criarBotaoPagina(i, pagination.currentPage === i);
      }
      
      // √öltima p√°gina (se n√£o estiver no final)
      if (endPage < pagination.totalPages) {
        if (endPage < pagination.totalPages - 1) {
          criarReticencias();
        }
        criarBotaoPagina(pagination.totalPages, false);
      }
    }
    
    function criarBotaoPagina(pageNum, isActive) {
      const button = document.createElement('button');
      button.textContent = pageNum;
      button.className = `px-3 py-1 rounded transition-colors ${isActive 
        ? 'bg-gold text-black font-semibold' 
        : 'bg-gray-600 hover:bg-gray-500 text-white'}`;
      
      if (!isActive) {
        button.addEventListener('click', () => carregarEMostrarAgendamentos(pageNum));
      }
      
      pageNumbers.appendChild(button);
    }
    
    function criarReticencias() {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'px-2 py-1 text-gray-400';
      pageNumbers.appendChild(dots);
    }
  }

  // ---- Delega√ß√£o de eventos para a lista de agendamentos ----
  function handleAgendamentosClick(e) {
    // Editar
    const editBtn = e.target.closest('.editar-agendamento-btn');
    if (editBtn) {
      const agendamentoId = String(editBtn.dataset.agendamentoId); 
      const agendamento = database.agendamentos.find(ag => String(ag.id) === agendamentoId);
      if (agendamento) {
        abrirModalEdicao(agendamento);
      } else {
        console.error('‚ùå Agendamento n√£o encontrado com ID:', agendamentoId);
      }
      return;
    }

    // Salvar status
    const saveBtn = e.target.closest('.salvar-status-btn');
    if (saveBtn) {
      const agendamentoId = saveBtn.dataset.agendamentoId;
      const select = document.querySelector(`select.status-select[data-agendamento-id="${agendamentoId}"]`);
      const novoStatus = select ? select.value : null;
      if (!novoStatus) return;

      saveBtn.disabled = true;
      const originalText = saveBtn.textContent;
      saveBtn.textContent = '‚è≥ Saving...';

      atualizarAgendamento(agendamentoId, { status: novoStatus })
        .then(() => {
          mostrarMensagem('Status updated successfully!', 'success');
          carregarEMostrarAgendamentos(currentPage);
        })
        .catch(err => {
          mostrarMensagem('Error updating status: ' + err.message, 'error');
        })
        .finally(() => {
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        });
      return;
    }

    // Excluir
    const delBtn = e.target.closest('.excluir-agendamento-btn');
    if (delBtn) {
      const agendamentoId = delBtn.dataset.agendamentoId;
      if (!confirm('Are you sure you want to delete this appointment?')) return;

      delBtn.disabled = true;
      const originalText = delBtn.textContent;
      delBtn.textContent = '‚è≥ Deleting...';

      excluirAgendamento(agendamentoId)
        .then(() => {
          mostrarMensagem('Appointment deleted successfully!', 'success');
          carregarEMostrarAgendamentos(currentPage);
        })
        .catch(err => {
          mostrarMensagem('Error deleting appointment: ' + err.message, 'error');
        })
        .finally(() => {
          delBtn.disabled = false;
          delBtn.textContent = originalText;
        });
    }
  }

  document.getElementById('agendamentosLista')?.addEventListener('click', handleAgendamentosClick);

  // Fun√ß√µes do Modal de Edi√ß√£o
  function abrirModalEdicao(agendamento) {
    const modal = document.getElementById('editModal');
    if (!modal) return;
    
    document.getElementById('editAgendamentoId').value = agendamento.id;
    document.getElementById('editNome').value = agendamento.nome || '';
    document.getElementById('editTelefone').value = agendamento.telefone || '';
    document.getElementById('editData').value = agendamento.data || '';
    document.getElementById('editHorario').value = agendamento.horario || '';
    document.getElementById('editStatus').value = agendamento.status || 'pendente';
    
    // Limpar todas as sele√ß√µes de servi√ßos primeiro
    document.querySelectorAll('input[name="editServicos"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    
    // Marcar os servi√ßos selecionados
    if (agendamento.servico) {
      const servicosSelecionados = agendamento.servico.split(', ').map(s => s.trim());
      servicosSelecionados.forEach(servico => {
        const checkbox = document.querySelector(`input[name="editServicos"][value="${servico}"]`);
        if (checkbox) checkbox.checked = true;
      });
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function fecharModalEdicao() {
    document.getElementById('editModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('editForm').reset();
    
    // Limpar tamb√©m os checkboxes de servi√ßos
    document.querySelectorAll('input[name="editServicos"]').forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  // Event listeners do modal
  document.getElementById('closeEditModal')?.addEventListener('click', fecharModalEdicao);
  document.getElementById('cancelEditBtn')?.addEventListener('click', fecharModalEdicao);
  
  // Formata√ß√£o de telefone no modal
  document.getElementById('editTelefone')?.addEventListener('input', (e) => {
    e.target.value = formatBRPhone(e.target.value);
  });
  
  // Fechar modal clicando fora
  document.getElementById('editModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'editModal') {
      fecharModalEdicao();
    }
  });

  // Fechar modal com ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('editModal').classList.contains('hidden')) {
      fecharModalEdicao();
    }
  });

  // Submit do formul√°rio de edi√ß√£o
  document.getElementById('editForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const agendamentoId = document.getElementById('editAgendamentoId').value;
    
    // Coletar servi√ßos selecionados (m√∫ltipla escolha)
    const servicosEls = document.querySelectorAll('input[name="editServicos"]:checked');
    const servicosSelecionados = Array.from(servicosEls).map(el => el.value);
    
    if (servicosSelecionados.length === 0) {
      mostrarMensagem('Error: Select at least one service', 'error');
      return;
    }
    
    const dadosAtualizados = {
      nome: document.getElementById('editNome').value.trim(),
      telefone: document.getElementById('editTelefone').value.trim(),
      servico: servicosSelecionados.join(', '), // Juntar com v√≠rgula
      data: document.getElementById('editData').value,
      horario: document.getElementById('editHorario').value,
      status: document.getElementById('editStatus').value
    };

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Saving...';

    try {
      await atualizarAgendamento(agendamentoId, dadosAtualizados);
      
      mostrarMensagem('Appointment updated successfully!', 'success');
      fecharModalEdicao();
      carregarEMostrarAgendamentos(currentPage); // Recarrega a lista
    } catch (err) {
      console.error('Erro detalhado ao atualizar:', err);
      mostrarMensagem('Error updating appointment: ' + err.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  function mostrarMensagem(texto, tipo) {
    const msg = document.getElementById('agendamentosMsg');
    msg.textContent = texto;
    
    let classes = 'mt-4 p-3 rounded-lg ';
    switch(tipo) {
      case 'error':
        classes += 'bg-red-900/50 border border-red-500 text-red-200';
        break;
      case 'success':
        classes += 'bg-green-900/50 border border-green-500 text-green-200';
        break;
      case 'info':
        classes += 'bg-blue-900/50 border border-blue-500 text-blue-200';
        break;
      default:
        classes += 'bg-green-900/50 border border-green-500 text-green-200';
    }
    
    msg.className = classes;
    msg.classList.remove('hidden');
    setTimeout(() => msg.classList.add('hidden'), 5000);
  }

  function filtrarAgendamentos() {
    // Aplicar filtros resetando para a primeira p√°gina
    carregarEMostrarAgendamentos(1);
  }

  // Event listeners para agendamentos
  document.getElementById('recarregarAgendamentos')?.addEventListener('click', () => {
    carregarEMostrarAgendamentos(currentPage);
  });

  document.getElementById('limparAgendamentosPassados')?.addEventListener('click', async () => {
    const confirmacao = confirm(
      'Are you sure you want to remove ALL past appointments?\n\n' +
      'This action cannot be undone!'
    );
    
    if (!confirmacao) return;

    const btn = document.getElementById('limparAgendamentosPassados');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '‚è≥ Cleaning...';

    try {
      const resultado = await limparAgendamentosPassados();
      
      if (resultado.removidos === 0) {
        mostrarMensagem(resultado.message, 'info');
      } else {
        mostrarMensagem(
          `‚úÖ ${resultado.removidos} past appointment(s) removed successfully!`, 
          'success'
        );
        
        // Recarregar a lista de agendamentos ap√≥s limpeza
        carregarEMostrarAgendamentos(1); // Volta para primeira p√°gina
      }
      
      console.log('üìä Detalhes da limpeza:', resultado);
      
    } catch (err) {
      console.error('Erro ao limpar agendamentos passados:', err);
      mostrarMensagem('Error cleaning past appointments: ' + err.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });
  
  document.getElementById('filtroData')?.addEventListener('change', filtrarAgendamentos);
  document.getElementById('filtroStatus')?.addEventListener('change', filtrarAgendamentos);
  
  document.getElementById('limparFiltros')?.addEventListener('click', () => {
    carregarEMostrarAgendamentos(1, true); // true = resetFilters
  });

  // Event listeners para pagina√ß√£o
  document.getElementById('prevPageBtn')?.addEventListener('click', () => {
    if (currentPage > 1) {
      carregarEMostrarAgendamentos(currentPage - 1);
    }
  });

  document.getElementById('nextPageBtn')?.addEventListener('click', () => {
    if (currentPage < totalPages) {
      carregarEMostrarAgendamentos(currentPage + 1);
    }
  });

  document.getElementById('firstPageBtn')?.addEventListener('click', () => {
    if (currentPage !== 1) {
      carregarEMostrarAgendamentos(1);
    }
  });

  document.getElementById('lastPageBtn')?.addEventListener('click', () => {
    if (currentPage !== totalPages) {
      carregarEMostrarAgendamentos(totalPages);
    }
  });

  // ---- NOVO: MODAL DE NOVO AGENDAMENTO ----
  
  function abrirModalNovoAgendamento() {
      document.getElementById('novoAgendamentoModal').classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      
      // Limpar formul√°rio
      document.getElementById('novoAgendamentoForm').reset();
      
      // Limpar o select de hor√°rios
      const horarioSelect = document.getElementById('novoHorario');
      horarioSelect.innerHTML = '<option value="">Select a date first</option>';
      
      // Definir data m√≠nima como hoje
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('novoData').min = hoje;
      
      // Selecionar "confirmado" por padr√£o
      document.getElementById('novoStatus').value = 'confirmado';
  }

  function fecharModalNovoAgendamento() {
      document.getElementById('novoAgendamentoModal').classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
  }

  // Event listeners do modal de novo agendamento
  document.getElementById('novoAgendamentoBtn')?.addEventListener('click', abrirModalNovoAgendamento);
  document.getElementById('closeNovoAgendamentoModal')?.addEventListener('click', fecharModalNovoAgendamento);
  document.getElementById('cancelNovoAgendamentoBtn')?.addEventListener('click', fecharModalNovoAgendamento);

  document.getElementById('novoAgendamentoModal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
          fecharModalNovoAgendamento();
      }
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('novoAgendamentoModal').classList.contains('hidden')) {
      fecharModalNovoAgendamento();
    }
  });

  // Submiss√£o do formul√°rio de novo agendamento
  document.getElementById('novoAgendamentoForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const servicosEls = Array.from(document.querySelectorAll('input[name="novoServicos"]:checked'));
      const servicosErro = document.getElementById('novoServicosErro');

      if (servicosEls.length === 0) {
          servicosErro.classList.remove('hidden');
          return;
      } else {
          servicosErro.classList.add('hidden');
      }

      const dadosAgendamento = {
          nome: document.getElementById('novoNome').value.trim(),
          telefone: document.getElementById('novoTelefone').value.trim(),
          servico: servicosEls.map(el => el.value).join(', '),
          data: document.getElementById('novoData').value,
          horario: document.getElementById('novoHorario').value,
          status: document.getElementById('novoStatus').value
      };

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Creating...';
      
      try {
          await apiPost('/agendamentos', dadosAgendamento);
          
          mostrarMensagem('Appointment created successfully!', 'success');
          fecharModalNovoAgendamento();
          carregarEMostrarAgendamentos(1, true); // Recarrega a lista na p√°gina 1 e limpa filtros
      } catch (error) {
          console.error('Error creating appointment:', error);
          mostrarMensagem(`Error: ${error.message}`, 'error');
      } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
      }
  });

  // M√°scara e valida√ß√£o para telefone (igual ao index.html)
  const novoTelefoneInput = document.getElementById('novoTelefone');
  
  function formatBRPhone(value) {
      const d = value.replace(/\D/g, '').slice(0, 11);
      const len = d.length;

      if (!len) return '';

      if (len <= 2) {
          return `(${d}`;
      } else if (len <= 6) {
          return `(${d.slice(0, 2)}) ${d.slice(2)}`;
      } else if (len <= 10) {
          return `(${d.slice(0, 2)}) ${d.slice(2, 6)}-${d.slice(6)}`;
      } else {
          return `(${d.slice(0, 2)}) ${d.slice(2, 7)}-${d.slice(7, 11)}`;
      }
  }

  novoTelefoneInput?.addEventListener('input', (e) => {
      e.target.value = formatBRPhone(e.target.value);
  });
  
  novoTelefoneInput?.addEventListener('blur', (e) => {
      const ok = /^\(\d{2}\) \d{4,5}-\d{4}$/.test(e.target.value);
      e.target.setCustomValidity(ok || e.target.value === '' ? '' : 'Enter a valid phone: (11) 91234-5678');
  });

  // Sistema de hor√°rios dispon√≠veis (baseado no index.html e adaptado para admin)
  const diasSemanaMap = {
      'Segunda-feira': 'segunda',
      'Ter√ßa-feira': 'terca',
      'Quarta-feira': 'quarta',
      'Quinta-feira': 'quinta',
      'Sexta-feira': 'sexta',
      'S√°bado': 'sabado',
      'Domingo': 'domingo'
  };

  async function carregarHorariosAgendadosParaData(data) {
      try {
          const todosAgendamentos = await apiGet(`/agendamentos?data=${data}`);
          return todosAgendamentos.filter(ag => ag.status === 'confirmado');
      } catch (error) {
          console.warn('‚ö†Ô∏è Error loading scheduled appointments:', error);
          return [];
      }
  }

  // Event listener para mudan√ßa de data no modal de novo agendamento
  document.getElementById('novoData')?.addEventListener('change', async function () {
      const dataSelecionada = this.value;
      const horarioSelect = document.getElementById('novoHorario');

      if (!dataSelecionada) {
          horarioSelect.innerHTML = '<option value="">Select a date first</option>';
          return;
      }

      // Descobrir o dia da semana
      const data = new Date(`${dataSelecionada}T00:00:00`);
      const nomeDia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
      const nomeDiaFormatado = nomeDia.charAt(0).toUpperCase() + nomeDia.slice(1);
      const diaChave = diasSemanaMap[nomeDiaFormatado];

      const horariosDisponiveis = database.horarios; // Usa os hor√°rios j√° carregados
      const agendamentosConfirmados = await carregarHorariosAgendadosParaData(dataSelecionada);
      const horariosOcupados = new Set(agendamentosConfirmados.map(ag => ag.horario));

      const hoje = new Date();
      const dataAtual = hoje.toISOString().split('T')[0];
      const horaAtual = hoje.toTimeString().split(' ')[0].substring(0, 5);
      const isHoje = dataSelecionada === dataAtual;

      horarioSelect.innerHTML = '<option value="">Select a time</option>';

      if (diaChave && Array.isArray(horariosDisponiveis[diaChave])) {
          const horariosDoDia = horariosDisponiveis[diaChave];
          if (horariosDoDia.length === 0) {
              horarioSelect.innerHTML = '<option value="">Closed on this day</option>';
          } else {
              let horariosValidos = 0;
              horariosDoDia.forEach(h => {
                  if (isHoje && h <= horaAtual) return; // Pula hor√°rio passado

                  const opt = document.createElement('option');
                  opt.value = h;
                  if (horariosOcupados.has(h)) {
                      opt.textContent = `${h} (Occupied)`;
                      opt.disabled = true;
                      opt.style.color = '#999';
                  } else {
                      opt.textContent = h;
                  }
                  horarioSelect.appendChild(opt);
                  horariosValidos++;
              });

              if (horariosValidos === 0) {
                  horarioSelect.innerHTML = `<option value="">${isHoje ? 'All times have passed' : 'All times are occupied'}</option>`;
              }
          }
      } else {
          horarioSelect.innerHTML = '<option value="">No schedules available</option>';
      }
  });
  
  // ---- BOT√ÉO FLUTUANTE - VOLTAR AO TOPO ----
  const backToTopBtn = document.getElementById('backToTopBtn');
  const horariosTab = document.getElementById('horariosTab');
  
  function toggleBackToTopButton() {
    const isHorariosTabVisible = !horariosTab.classList.contains('hidden');
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    if (isHorariosTabVisible && scrollTop > 300) {
      backToTopBtn.classList.remove('opacity-0', 'invisible');
      backToTopBtn.classList.add('opacity-100', 'visible');
    } else {
      backToTopBtn.classList.add('opacity-0', 'invisible');
      backToTopBtn.classList.remove('opacity-100', 'visible');
    }
  }
  
  window.addEventListener('scroll', toggleBackToTopButton);
  
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      setTimeout(toggleBackToTopButton, 100);
    });
  });
  
  backToTopBtn?.addEventListener('click', () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  });
  
  toggleBackToTopButton();
 </script>

</body>

</html>