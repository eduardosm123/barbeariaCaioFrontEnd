<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin · Barbearia VIP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { gold:'#D4AF37', darkgold:'#B8941F' } } }
    };
  </script>
</head>
<body class="bg-gray-900 text-white">
  <!-- Navbar -->
  <header class="w-full bg-black/95 border-b border-gray-800 sticky top-0 z-50">
    <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="text-white/70 hover:text-white">← Voltar</a>
      <div class="text-2xl font-bold text-gold">Admin · Agendamentos</div>
      <div class="flex items-center gap-4">
        <div class="text-sm text-white/60" id="lastSync">—</div>
        <button id="btnSair" class="text-white/70 hover:text-white text-sm border border-gray-700 px-3 py-1 rounded">Sair</button>
      </div>
    </nav>
  </header>

  <!-- Filtros -->
  <section class="container mx-auto px-4 mt-6">
    <div class="bg-gray-800/70 rounded-xl p-4 border border-gray-700 flex gap-3 flex-col md:flex-row md:items-center md:justify-between">
      <div class="flex gap-2 items-center">
        <label class="text-white/70 text-sm">Status:</label>
        <select id="filtroStatus" class="bg-gray-900 border border-gray-700 rounded px-3 py-2">
          <option value="">Todos</option>
          <option value="pendente">Pendente</option>
          <option value="confirmado">Confirmado</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </div>

      <div class="flex gap-2 items-center">
        <input id="busca" type="search" placeholder="Buscar por nome/telefone/serviço..."
               class="w-72 max-w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 outline-none"/>
        <button id="btnRecarregar" class="bg-gold text-black font-semibold px-4 py-2 rounded hover:bg-darkgold">
          Recarregar
        </button>
      </div>
    </div>
  </section>

  <!-- Alertas -->
  <div id="alertBox" class="container mx-auto px-4 mt-4 hidden">
    <div id="alertInner" class="rounded-lg px-4 py-3"></div>
  </div>

  <!-- Lista -->
  <main class="container mx-auto px-4 my-6">
    <div id="lista" class="grid gap-4"></div>
  </main>

  <!-- Login Modal (aparece se não houver sessão) -->
  <div id="loginModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-sm p-6">
      <h2 class="text-xl font-semibold mb-4">Entrar</h2>
      <p class="text-white/70 text-sm mb-4">Faça login para gerenciar os agendamentos.</p>
      <form id="loginForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1 text-white/80" for="loginUser">Usuário</label>
          <input id="loginUser" type="text" required class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1 text-white/80" for="loginPass">Senha</label>
          <input id="loginPass" type="password" required class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
        </div>
        <button class="w-full bg-gold hover:bg-darkgold text-black font-semibold rounded px-4 py-2">Entrar</button>
      </form>
      <p id="loginMsg" class="text-red-300 text-sm mt-3 hidden"></p>
    </div>
  </div>

  <template id="tpl-card">
    <div class="rounded-xl bg-gray-800 border border-gray-700 p-5" data-id="">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div class="space-y-2">
          <h3 class="text-xl font-semibold">
            <span class="nome">—</span>
            <span class="ml-2 text-xs px-2 py-1 rounded-full align-middle status-badge">status</span>
          </h3>
          <div class="text-white/80 text-sm">
            <div><span class="font-semibold">Telefone:</span> <span class="tel">—</span></div>
            <div><span class="font-semibold">Serviço(s):</span> <span class="servico">—</span></div>
          </div>
        </div>

        <div class="text-right text-sm text-white/80">
          <div><span class="font-semibold">Data:</span> <span class="data">—</span></div>
          <div><span class="font-semibold">Horário:</span> <span class="horario">—</span></div>
          <div><span class="font-semibold">Criado em:</span> <span class="criado">—</span></div>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <select class="seletor-status bg-gray-900 border border-gray-700 rounded px-3 py-2">
          <option value="pendente">Pendente</option>
          <option value="confirmado">Confirmado</option>
          <option value="cancelado">Cancelado</option>
        </select>

        <button class="btn-salvar bg-emerald-500 hover:bg-emerald-600 text-white font-semibold px-4 py-2 rounded">
          Salvar
        </button>
        <button class="btn-excluir bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded">
          Excluir
        </button>
      </div>
    </div>
  </template>

  <script>
    // =======================
    // Config
    // =======================
    const API_BASE = 'https://barbeariacaio.onrender.com';

    // =======================
    // Sessão
    // =======================
    const getSessionId = () => localStorage.getItem('sessionId');
    const setSessionId = (sid) => localStorage.setItem('sessionId', sid || '');
    const clearSession = () => localStorage.removeItem('sessionId');

    const showLogin = (msg='') => {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('loginModal').classList.add('flex');
      const p = document.getElementById('loginMsg');
      if (msg) { p.textContent = msg; p.classList.remove('hidden'); } else { p.classList.add('hidden'); }
    };
    const hideLogin = () => {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginModal').classList.remove('flex');
      document.getElementById('loginMsg').classList.add('hidden');
    };

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPass').value.trim();

      try {
        const r = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if (!r.ok) {
          let msg = 'Falha no login.';
          try { const j = await r.json(); if (j?.message) msg = j.message; } catch {}
          throw new Error(msg);
        }
        const j = await r.json();
        if (!j.sessionId) throw new Error('Resposta sem sessionId.');
        setSessionId(j.sessionId);
        hideLogin();
        await carregarAgendamentos();
      } catch (err) {
        document.getElementById('loginMsg').textContent = err.message;
        document.getElementById('loginMsg').classList.remove('hidden');
      }
    });

    document.getElementById('btnSair').addEventListener('click', () => {
      clearSession();
      showLogin('Sessão encerrada. Faça login novamente.');
    });

    // =======================
    // Helpers UI
    // =======================
    const getId = (ag) => ag?._id ?? ag?.id ?? null;

    const fmtDateBR = (str) => {
      if (!str) return '-';
      const d = new Date(str);
      if (isNaN(d)) return '-';
      return d.toLocaleDateString('pt-BR');
    };

    const statusLabel = (s) => {
      switch ((s || '').toLowerCase()) {
        case 'confirmado': return 'Confirmado';
        case 'cancelado':  return 'Cancelado';
        default:           return 'Pendente';
      }
    };

    const badgeClasses = (s) => {
      s = (s || '').toLowerCase();
      if (s === 'confirmado') return 'bg-emerald-500/15 text-emerald-300 border border-emerald-700';
      if (s === 'cancelado')  return 'bg-red-500/15 text-red-300 border border-red-700';
      return 'bg-yellow-500/15 text-yellow-300 border border-yellow-700';
    };

    const showAlert = (type, msg) => {
      const box = document.getElementById('alertBox');
      const inner = document.getElementById('alertInner');
      inner.className = 'rounded-lg px-4 py-3';
      if (type === 'error') inner.classList.add('bg-red-900/40', 'text-red-200', 'border', 'border-red-700');
      else if (type === 'success') inner.classList.add('bg-emerald-900/40', 'text-emerald-200', 'border', 'border-emerald-700');
      else inner.classList.add('bg-gray-800', 'text-white/90', 'border', 'border-gray-700');
      inner.textContent = msg;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 3500);
    };

    // =======================
    // API helpers (sempre com x-session-id)
    // =======================
    async function apiGet(path) {
      const sid = getSessionId();
      const r = await fetch(`${API_BASE}${path}`, {
        cache: 'no-store',
        headers: sid ? { 'x-session-id': sid } : {}
      });
      if (r.status === 401) { showLogin('Sessão inválida ou expirada. Faça login.'); throw new Error('401 Unauthorized'); }
      if (!r.ok) throw new Error(`GET ${path} -> ${r.status}`);
      return r.json();
    }

    async function apiPatch(path, body) {
      const sid = getSessionId();
      const r = await fetch(`${API_BASE}${path}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', ...(sid ? { 'x-session-id': sid } : {}) },
        body: JSON.stringify(body || {})
      });
      if (r.status === 401) {
        showLogin('Sessão inválida ou expirada. Faça login.');
        throw new Error('401 Unauthorized');
      }
      if (!r.ok) {
        let message = `PATCH ${path} -> ${r.status}`;
        try { const j = await r.json(); if (j?.message) message = j.message; } catch {}
        throw new Error(message);
      }
      return r.json();
    }

    async function apiDelete(path) {
      const sid = getSessionId();
      const r = await fetch(`${API_BASE}${path}`, {
        method: 'DELETE',
        headers: sid ? { 'x-session-id': sid } : {}
      });
      if (r.status === 401) {
        showLogin('Sessão inválida ou expirada. Faça login.');
        throw new Error('401 Unauthorized');
      }
      if (!r.ok) throw new Error(`DELETE ${path} -> ${r.status}`);
      try { return await r.json(); } catch { return true; }
    }

    // =======================
    // Storage (fallback)
    // =======================
    function getLocalAgendamentos() {
      try {
        const db = JSON.parse(localStorage.getItem('barbeariaAdmin') || '{}');
        return Array.isArray(db.agendamentos) ? db.agendamentos : [];
      } catch { return []; }
    }

    // =======================
    // Carregar + Renderizar
    // =======================
    let AGENDAMENTOS = [];

    async function carregarAgendamentos() {
      let lista = [];
      try {
        const api = await apiGet('/agendamentos');
        lista = api;
        document.getElementById('lastSync').textContent =
          'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');
      } catch (e) {
        // se foi 401, o modal já foi exibido por apiGet/apiPatch/apiDelete
        if (String(e.message).includes('401')) return;
        console.warn('Falha ao buscar na API, usando localStorage:', e.message);
        showAlert('error', 'Não foi possível sincronizar com o servidor. Exibindo dados locais.');
        lista = getLocalAgendamentos();
      }

      // deduplicar por id (_id | id)
      const map = new Map();
      for (const ag of lista.concat(getLocalAgendamentos())) {
        const id = getId(ag);
        if (!id) continue;
        map.set(id, { ...ag, _id: id, id });
      }
      AGENDAMENTOS = Array.from(map.values());
      renderLista();
    }

    function renderLista() {
      const wrap = document.getElementById('lista');
      wrap.innerHTML = '';

      const q = (document.getElementById('busca').value || '').toLowerCase();
      const fStatus = (document.getElementById('filtroStatus').value || '').toLowerCase();

      const filtrados = AGENDAMENTOS.filter(ag => {
        const hay =
          (ag.nome || '').toLowerCase().includes(q) ||
          (ag.telefone || '').toLowerCase().includes(q) ||
          (ag.servico || ag.servicos?.join(', ') || '').toLowerCase().includes(q);
        const statusOk = !fStatus || (ag.status || 'pendente').toLowerCase() === fStatus;
        return hay && statusOk;
      });

      if (filtrados.length === 0) {
        wrap.innerHTML = `<div class="text-white/60 text-center py-12 border border-dashed border-gray-700 rounded-xl">
          Nenhum agendamento encontrado.
        </div>`;
        return;
      }

      const tpl = document.getElementById('tpl-card');
      filtrados
        .sort((a, b) => (String(b.data)+String(b.horario)).localeCompare(String(a.data)+String(a.horario)))
        .forEach(ag => wrap.appendChild(criarCard(tpl, ag)));
    }

    function criarCard(tpl, ag) {
      const node = tpl.content.firstElementChild.cloneNode(true);
      const id = getId(ag);
      node.dataset.id = id;

      const nomeEl = node.querySelector('.nome');
      const telEl  = node.querySelector('.tel');
      const servEl = node.querySelector('.servico');
      const dataEl = node.querySelector('.data');
      const horaEl = node.querySelector('.horario');
      const criEl  = node.querySelector('.criado');
      const badge  = node.querySelector('.status-badge');
      const select = node.querySelector('.seletor-status');
      const btnSalvar  = node.querySelector('.btn-salvar');
      const btnExcluir = node.querySelector('.btn-excluir');

      const status = (ag.status || 'pendente').toLowerCase();

      nomeEl.textContent = ag.nome || '—';
      telEl.textContent  = ag.telefone || '—';
      servEl.textContent = ag.servico || (Array.isArray(ag.servicos) ? ag.servicos.join(', ') : '—');
      dataEl.textContent = ag.data ? ag.data.split('-').reverse().join('/') : '—';
      horaEl.textContent = ag.horario || '—';
      criEl.textContent  = fmtDateBR(ag.createdAt || ag.criadoEm || ag.timestamp);

      badge.textContent = statusLabel(status);
      badge.className = 'ml-2 text-xs px-2 py-1 rounded-full align-middle status-badge ' + badgeClasses(status);
      select.value = status;

      select.addEventListener('change', () => {
        const novo = select.value;
        badge.textContent = statusLabel(novo);
        badge.className = 'ml-2 text-xs px-2 py-1 rounded-full align-middle status-badge ' + badgeClasses(novo);
      });

      btnSalvar.addEventListener('click', async () => {
        const novoStatus = select.value;
        if (!id) return showAlert('error', 'ID ausente neste agendamento.');

        btnSalvar.disabled = true;
        const oldText = btnSalvar.textContent;
        btnSalvar.textContent = 'Salvando...';
        try {
          await apiPatch(`/agendamentos/${id}`, { status: novoStatus });
          const idx = AGENDAMENTOS.findIndex(x => getId(x) === id);
          if (idx >= 0) AGENDAMENTOS[idx].status = novoStatus;
          showAlert('success', 'Status atualizado com sucesso.');
        } catch (e) {
          if (!String(e.message).includes('401')) {
            showAlert('error', `Erro ao atualizar status: ${e.message}`);
          }
        } finally {
          btnSalvar.disabled = false;
          btnSalvar.textContent = oldText;
        }
      });

      btnExcluir.addEventListener('click', async () => {
        if (!id) return showAlert('error', 'ID ausente neste agendamento.');
        const ok = confirm('Tem certeza que deseja excluir este agendamento?');
        if (!ok) return;

        btnExcluir.disabled = true;
        const old = btnExcluir.textContent;
        btnExcluir.textContent = 'Excluindo...';
        try {
          await apiDelete(`/agendamentos/${id}`);
          AGENDAMENTOS = AGENDAMENTOS.filter(x => getId(x) !== id);
          node.remove();
          showAlert('success', 'Agendamento excluído.');
        } catch (e) {
          if (!String(e.message).includes('401')) {
            showAlert('error', `Erro ao excluir: ${e.message}`);
          }
        } finally {
          btnExcluir.disabled = false;
          btnExcluir.textContent = old;
        }
      });

      return node;
    }

    // =======================
    // Eventos UI
    // =======================
    document.getElementById('btnRecarregar').addEventListener('click', carregarAgendamentos);
    document.getElementById('busca').addEventListener('input', renderLista);
    document.getElementById('filtroStatus').addEventListener('change', renderLista);

    // start: se não houver sessão, abrir login; senão carregar lista
    (async () => {
      const sid = getSessionId();
      if (!sid) {
        showLogin();
      } else {
        try {
          await carregarAgendamentos();
        } catch {
          showLogin('Sessão inválida ou expirada. Faça login.');
        }
      }
    })();
  </script>
</body>
</html>
